### Title: CLOB Authentication Broken: Refactor to Adopt Polymarket/agents Simplicity

# CLOB Authentication Crisis: Adopt Polymarket/agents Approach

Based on my investigation, I've discovered a **critical architectural difference** between our failing TypeScript implementation and the working Python agents repository. 

## The Core Problem

Polymarket-Sniper-Bot has been through ~100 iterations trying to fix CLOB API credential derivation, yet **the upstream Polymarket/agents repository (Python)** handles this flawlessly with a dramatically simpler approach. 

### Polymarket/agents (Python) - WORKING ✅
The working implementation is almost trivially simple:

```python
# agents/polymarket/polymarket.py
class Polymarket:
    def _init_api_keys(self) -> None:
        self.client = ClobClient(
            self.clob_url, key=self.private_key, chain_id=self.chain_id
        )
        self.credentials = self.client.create_or_derive_api_creds()
        self.client.set_api_creds(self.credentials)
```

**That's it.** One call to `create_or_derive_api_creds()`, set it on the client, move on.

### Polymarket-Sniper-Bot (TypeScript) - FAILING ❌
Your implementation has accumulated massive complexity:

```typescript
// src/clob/credential-derivation-v2.ts (excerpt)
export async function deriveCredentialsWithFallback(params: ExtendedIdentityResolverParams): Promise<DerivationResult> {
  const singleFlight = getSingleFlightDerivation(params.logger, params.structuredLogger);
  
  // Single-flight coordination with exponential backoff
  // Check single-flight status before proceeding
  // Fallback ladder with 5 attempt combinations (A-E)
  // Address swapping logic for 401 errors
  // Cache verification and re-derivation
  // Signature type auto-detection
  // ... and much more
}
```

Features present in the current repo but absent in agents:
- ✗ Fallback ladder (EOA/Proxy/Safe combinations)
- ✗ Exponential backoff system
- ✗ Credential caching with complex invalidation logic
- ✗ L1/L2 auth identity resolution with swapping
- ✗ Signature type auto-detection
- ✗ Address override mechanisms
- ✗ StructuredLogger hooks everywhere

**None of these exist in the working agents repo.**

## Key Code References
**Python (Working):**
- [Polymarket/agents/agents/polymarket/polymarket.py - _init_api_keys()](https://github.com/Polymarket/agents/blob/081f2b5594c37edeb9d3780a778c084d5b6f2743/agents/polymarket/polymarket.py#L72-L78)
- [test() function showing exact credential flow](https://github.com/Polymarket/agents/blob/081f2b5594c37edeb9d3780a778c084d5b6f2743/agents/polymarket/polymarket.py#L361-L385)

**TypeScript (Failing):**
- [src/clob/credential-derivation-v2.ts - overly complex fallback system](https://github.com/telix5000/Polymarket-Sniper-Bot/blob/3ea457a58e63d60bde1d975a72662989f68d9050/src/clob/credential-derivation-v2.ts)
- [src/clob/simple-auth.ts - additional auth wrapper](https://github.com/telix5000/Polymarket-Sniper-Bot/blob/3ea457a58e63d60bde1d975a72662989f68d9050/src/clob/simple-auth.ts)
- [AUTH_ANALYSIS_FINDINGS.md - analysis that claims to match agents but clearly doesn't](https://github.com/telix5000/Polymarket-Sniper-Bot/blob/3ea457a58e63d60bde1d975a72662989f68d9050/AUTH_ANALYSIS_FINDINGS.md)

## What's Actually Happening
Your logs show: 
```
[CredDerive] Verification failed: 401 Unauthorized/Invalid api key
[AuthFallback] ❌ Failed: A) EOA + signer auth (401) - Credentials failed verification
[AuthFallback] All 5 credential derivation attempts failed
```
The agents repo would simply: 
1. Call `create_or_derive_api_creds()` once
2. Either succeed and set credentials, or fail immediately
3. No fallback ladder, no address swapping, no retries

## The Root Cause
The complex fallback system was designed to handle multiple wallet types (EOA, Safe, Proxy) and signature types automatically. However: 
1. **The py-clob-client library handles all of this internally** - you don't need to do it yourself
2. **The @polymarket/clob-client TypeScript library likely does too** - but your code is fighting against it
3. **Every fallback attempt, address swap, and signature type guess is adding points of failure** instead of solving anything

Your own documentation (AUTH_FIX_2025_01_19.md) shows you already knew this: 

> **Root Cause:** The bot's `attemptDerive()` function was calling `deriveApiKey()` first → Returns 401 if credentials don't exist yet, then `createApiKey()` as fallback → May invalidate/rotate existing credentials

Yet you've rebuilt the same complexity with a different structure.

## Recommendation: Complete Rewrite of Auth Module
**Replace** `src/clob/credential-derivation-v2.ts`, `src/clob/simple-auth.ts`, and related fallback logic with a single, minimal implementation:

```typescript
// Simplified, agents-style approach
async function initializeApiCredentials(
  privateKey: string,
  clobUrl: string,
  chainId: number,
): Promise<ApiKeyCreds> {
  const client = new ClobClient(clobUrl, Chain.POLYGON, asClobSigner(new Wallet(privateKey)));
  
  // One call. That's it.
  const creds = await client.createOrDeriveApiKey();
  
  if (!creds || !creds.key || !creds.secret || !creds.passphrase) {
    throw new Error("Failed to derive/create API credentials");
  }
  
  return creds;
}
```

**Remove:** 
- ✗ All fallback ladder code
- ✗ Exponential backoff and single-flight coordination
- ✗ Address swapping logic
- ✗ Signature type auto-detection
- ✗ Complex caching with invalidation
- ✗ Identity resolution with forced overrides

The `@polymarket/clob-client` SDK should handle wallet mode detection internally, just like `py-clob-client` does.

## Next Steps
1. **Port the Python approach 1:1 to TypeScript** - strip all fallback/retry logic
2. **Test with a brand-new wallet** that has never traded on Polymarket
3. **If it fails with `createOrDeriveApiKey()`, file an issue with @polymarket/clob-client** - the SDK should handle first-time credential creation automatically
4. **Do NOT add fallback ladders** - if the SDK doesn't work, the SDK is broken, not your orchestration logic
